#!/usr/bin/env /src/bin/php-exec
<?php declare(strict_types=1);

use App\Core\Manticore;

$Client = Manticore::client();
$Embed = container('embed');
$offset = 0;
$limit = 1000;
while (true) {
	$list = $Client->sql("SELECT * FROM image WHERE id > $offset ORDER BY ID ASC LIMIT $limit");
	$hits = $list['hits']['hits'] ?? [];

	if (empty($hits)) {
		break;
	}

	foreach ($hits as $hit) {
		Cli::print('#' . $hit['_id']);
		if ($hit['_source']['caption']) {
			Cli::print(' skipping');
			continue;
		}
		$image_path = $hit['_source']['image_path'];
		$path = getenv('ENV_DIR') . $image_path;
		$embeddings = $hit['_source']['embeddings'];
		$caption = $Embed->getImageCaption($path)->unwrap();
		Cli::print(' caption: ' . $caption);
		$query = sprintf('REPLACE INTO image (id, image_path, caption, embeddings) VALUES (%d, \'%s\', \'%s\', (%s))', $hit['_id'], $image_path, addcslashes($caption, "'"), implode(',',$embeddings));
		$Client->sql($query, true);
	}

	$offset += $limit;
}

